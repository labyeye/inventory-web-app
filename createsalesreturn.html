<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0"
    />
    <meta name="description" content="POS - Bootstrap Admin Template" />
    <meta
      name="keywords"
      content="admin, estimates, bootstrap, business, corporate, creative, invoice, html5, responsive, Projects"
    />
    <meta name="author" content="Dreamguys - Bootstrap Admin Template" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Dreams Pos admin template</title>

    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="assets/img/favicon.png"
    />

    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />

    <link rel="stylesheet" href="assets/css/bootstrap-datetimepicker.min.css" />

    <link rel="stylesheet" href="assets/css/animate.css" />

    <link rel="stylesheet" href="assets/plugins/select2/css/select2.min.css" />

    <link rel="stylesheet" href="assets/css/dataTables.bootstrap4.min.css" />

    <link
      rel="stylesheet"
      href="assets/plugins/fontawesome/css/fontawesome.min.css"
    />
    <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css" />

    <link rel="stylesheet" href="assets/css/style.css" />
  </head>
  <body>
    <div id="global-loader">
      <div class="whirly-loader"></div>
    </div>

    <div class="main-wrapper">
      <div class="header">
        <div class="header-left active">
          <a href="index.html" class="logo">
            <img src="assets/img/logo.png" alt="" />
          </a>
          <a href="index.html" class="logo-small">
            <img src="assets/img/logo-small.png" alt="" />
          </a>
          <a id="toggle_btn" href="javascript:void(0);"> </a>
        </div>

        <a id="mobile_btn" class="mobile_btn" href="#sidebar">
          <span class="bar-icon">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </a>

        <ul class="nav user-menu">
          <li class="nav-item">
            <div class="top-nav-search">
              <a href="javascript:void(0);" class="responsive-search">
                <i class="fa fa-search"></i>
              </a>
              <form action="#">
                <div class="searchinputs">
                  <input type="text" placeholder="Search Here ..." />
                  <div class="search-addon">
                    <span
                      ><img src="assets/img/icons/closes.svg" alt="img"
                    /></span>
                  </div>
                </div>
                <a class="btn" id="searchdiv"
                  ><img src="assets/img/icons/search.svg" alt="img"
                /></a>
              </form>
            </div>
          </li>

          <li class="nav-item dropdown has-arrow flag-nav">
            <a
              class="nav-link dropdown-toggle"
              data-bs-toggle="dropdown"
              href="javascript:void(0);"
              role="button"
            >
              <img src="assets/img/flags/us1.png" alt="" height="20" />
            </a>
            <div class="dropdown-menu dropdown-menu-right">
              <a href="javascript:void(0);" class="dropdown-item">
                <img src="assets/img/flags/us.png" alt="" height="16" /> English
              </a>
              <a href="javascript:void(0);" class="dropdown-item">
                <img src="assets/img/flags/fr.png" alt="" height="16" /> French
              </a>
              <a href="javascript:void(0);" class="dropdown-item">
                <img src="assets/img/flags/es.png" alt="" height="16" /> Spanish
              </a>
              <a href="javascript:void(0);" class="dropdown-item">
                <img src="assets/img/flags/de.png" alt="" height="16" /> German
              </a>
            </div>
          </li>

          <li class="nav-item dropdown">
            <a
              href="javascript:void(0);"
              class="dropdown-toggle nav-link"
              data-bs-toggle="dropdown"
            >
              <img src="assets/img/icons/notification-bing.svg" alt="img" />
              <span class="badge rounded-pill">4</span>
            </a>
            <div class="dropdown-menu notifications">
              <div class="topnav-dropdown-header">
                <span class="notification-title">Notifications</span>
                <a href="javascript:void(0)" class="clear-noti"> Clear All </a>
              </div>
              <div class="noti-content">
                <ul class="notification-list">
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-02.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">John Doe</span> added new
                            task
                            <span class="noti-title"
                              >Patient appointment booking</span
                            >
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">4 mins ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-03.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">Tarah Shropshire</span>
                            changed the task name
                            <span class="noti-title"
                              >Appointment booking with payment gateway</span
                            >
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">6 mins ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-06.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">Misty Tison</span> added
                            <span class="noti-title">Domenic Houston</span> and
                            <span class="noti-title">Claire Mapes</span> to
                            project
                            <span class="noti-title"
                              >Doctor available module</span
                            >
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">8 mins ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-17.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">Rolland Webber</span>
                            completed task
                            <span class="noti-title"
                              >Patient and Doctor video conferencing</span
                            >
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">12 mins ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-13.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">Bernardo Galaviz</span>
                            added new task
                            <span class="noti-title">Private chat module</span>
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">2 days ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="topnav-dropdown-footer">
                <a href="activities.html">View all Notifications</a>
              </div>
            </div>
          </li>

          <li class="nav-item dropdown has-arrow main-drop">
            <a
              href="javascript:void(0);"
              class="dropdown-toggle nav-link userset"
              data-bs-toggle="dropdown"
            >
              <span class="user-img"
                ><img src="assets/img/profiles/avator1.jpg" alt="" />
                <span class="status online"></span
              ></span>
            </a>
            <div class="dropdown-menu menu-drop-user">
              <div class="profilename">
                <div class="profileset">
                  <span class="user-img"
                    ><img src="assets/img/profiles/avator1.jpg" alt="" />
                    <span class="status online"></span
                  ></span>
                  <div class="profilesets">
                    <h6>John Doe</h6>
                    <h5>Admin</h5>
                  </div>
                </div>
                <hr class="m-0" />
                <a class="dropdown-item" href="profile.html">
                  <i class="me-2" data-feather="user"></i> My Profile</a
                >
                <a class="dropdown-item" href="generalsettings.html"
                  ><i class="me-2" data-feather="settings"></i>Settings</a
                >
                <hr class="m-0" />
                <a class="dropdown-item logout pb-0" href="signin.html"
                  ><img
                    src="assets/img/icons/log-out.svg"
                    class="me-2"
                    alt="img"
                  />Logout</a
                >
              </div>
            </div>
          </li>
        </ul>

        <div class="dropdown mobile-user-menu">
          <a
            href="javascript:void(0);"
            class="nav-link dropdown-toggle"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            ><i class="fa fa-ellipsis-v"></i
          ></a>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="profile.html">My Profile</a>
            <a class="dropdown-item" href="generalsettings.html">Settings</a>
            <a class="dropdown-item" href="signin.html">Logout</a>
          </div>
        </div>
      </div>

      <div class="sidebar" id="sidebar">
        <div class="sidebar-inner slimscroll">
          <div id="sidebar-menu" class="sidebar-menu">
            <ul>
              <li class="active">
                <a href="index.html"
                  ><img src="assets/img/icons/dashboard.svg" alt="img" /><span>
                    Dashboard</span
                  >
                </a>
              </li>
              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/product.svg" alt="img" /><span>
                    Inventory</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li><a href="./productlist.html">Inventory List</a></li>
                  <li><a href="./addproduct.html">Add Inventory</a></li>
                  <li><a href="./categorylist.html">Category List</a></li>
                  <li><a href="./addcategory.html">Add Category</a></li>
                  <li>
                    <a href="./subcategorylist.html">Sub Category List</a>
                  </li>
                  <li><a href="./subaddcategory.html">Add Sub Category</a></li>
                </ul>
              </li>
              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/sales1.svg" alt="img" /><span>
                    Events</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li><a href="saleslist.html">Events List</a></li>
                  <li><a href="addevent.html">New Event</a></li>
                </ul>
              </li>

              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/return1.svg" alt="img" /><span>
                    Return</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li>
                    <a href="salesreturnlist.html">Inventory Return List</a>
                  </li>
                  <li>
                    <a href="createsalesreturn.html">Add Inventory Return </a>
                  </li>
                </ul>
              </li>

              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/time.svg" alt="img" /><span>
                    Report</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li>
                    <a href="./purchaseorderreport.html">Event Order report</a>
                  </li>
                  <li><a href="./inventoryreport.html">Inventory Report</a></li>
                  <li>
                    <a href="./invoicereport.html">Inventory Return Report</a>
                  </li>
                  <li><a href="./purchasereport.html">Purchase Report</a></li>
                </ul>
              </li>
              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/users1.svg" alt="img" /><span>
                    Users</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li><a href="newuser.html">New User </a></li>
                  <li><a href="userlists.html">Users List</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="page-wrapper">
        <div class="content">
          <div class="page-header">
            <div class="page-title">
              <h4>Event Product Return</h4>
              <h6>Process product returns after event completion</h6>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Event Name</label>
                    <div class="row">
                      <div class="col-lg-10 col-sm-10 col-10">
                        <select class="select" id="eventSelect">
                          <option>Select Event</option>
                          <!-- Event options will be populated from Firebase -->
                        </select>
                      </div>
                      <div class="col-lg-2 col-sm-2 col-2 ps-0">
                        <div class="add-icon">
                          <a href="javascript:void(0);"
                            ><img src="assets/img/icons/plus1.svg" alt="img"
                          /></a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Event End Date</label>
                    <div class="input-groupicon">
                      <input
                        type="text"
                        placeholder="DD-MM-YYYY"
                        class="datetimepicker"
                        id="eventEndDate"
                      />
                      <div class="addonset">
                        <img src="assets/img/icons/calendars.svg" alt="img" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Reference No.</label>
                    <input
                      type="text"
                      placeholder="Enter reference number"
                      id="referenceNumber"
                    />
                  </div>
                </div>
                <div class="col-lg-12 mt-2">
                  <button class="btn btn-submit me-2" id="fetchProductsBtn">
                    Fetch Products In Use
                  </button>
                </div>
              </div>

              <div class="row mt-4">
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Product Name</th>
                        <th>Product ID</th>
                        <th>Allocated Qty</th>
                        <th>Returned Qty</th>
                        <th>Damaged Qty</th>
                        <th>Verification Status</th>
                        <th>Notes</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="productTableBody">
                      <!-- Product rows will be populated dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="row">
                <div class="col-lg-12 float-md-right">
                  <div class="total-order">
                    <ul>
                      <li>
                        <h4>Total Items Allocated</h4>
                        <h5 id="totalAllocated">0</h5>
                      </li>
                      <li>
                        <h4>Total Items Returned</h4>
                        <h5 id="totalReturned">0</h5>
                      </li>
                      <li>
                        <h4>Total Items Damaged</h4>
                        <h5 id="totalDamaged">0</h5>
                      </li>
                      <li class="total">
                        <h4>Verification Status</h4>
                        <h5 id="overallStatus">Pending</h5>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Return Notes</label>
                    <textarea
                      class="form-control"
                      id="returnNotes"
                      placeholder="Add any additional notes about the return process"
                    ></textarea>
                  </div>
                </div>
                <div class="col-lg-12">
                  <a
                    href="javascript:void(0);"
                    class="btn btn-submit me-2"
                    id="submitReturnBtn"
                    >Submit Return</a
                  >
                  <a href="salesreturnlist.html" class="btn btn-cancel"
                    >Cancel</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="assets/js/jquery-3.6.0.min.js"></script>
    <script src="assets/js/feather.min.js"></script>
    <script src="assets/js/jquery.slimscroll.min.js"></script>
    <script src="assets/js/jquery.dataTables.min.js"></script>
    <script src="assets/js/dataTables.bootstrap4.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/plugins/select2/js/select2.min.js"></script>
    <script src="assets/js/moment.min.js"></script>
    <script src="assets/js/bootstrap-datetimepicker.min.js"></script>
    <script src="assets/plugins/sweetalert/sweetalert2.all.min.js"></script>
    <script src="assets/plugins/sweetalert/sweetalerts.min.js"></script>

    <script type="module">
      import { auth, db } from "./assets/js/firebase.js";
      import {
        collection,
        addDoc,
        getDocs,
        query,
        where,
        serverTimestamp,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

      // Load events from Firebase when the page loads
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          await loadEventsFromFirebase();
          initializeFormElements();
        } catch (error) {
          console.error("Error during initialization:", error);
          showError("Failed to initialize the page: " + error.message);
        }
      });

      // Function to load events from Firebase
      async function loadEventsFromFirebase() {
        try {
          const eventsSnapshot = await getDocs(collection(db, "events"));
          const eventSelect = document.getElementById("eventSelect");

          // Clear existing options except the first one
          while (eventSelect.options.length > 1) {
            eventSelect.remove(1);
          }

          // Add events from Firebase
          if (eventsSnapshot.empty) {
            console.log("No events found in the database");
            showInfo("No events found in the database.");
            return;
          }

          eventsSnapshot.forEach((doc) => {
            const eventData = doc.data();
            const option = document.createElement("option");
            option.value = eventData.eventName || doc.id;
            option.text = eventData.eventName || "Event " + doc.id;
            option.dataset.eventId = doc.id;
            option.dataset.eventEndDate = eventData.endDate || "";
            eventSelect.appendChild(option);
          });

          console.log(`Loaded ${eventsSnapshot.size} events from Firebase`);
        } catch (error) {
          console.error("Error loading events:", error);
          showError("Failed to load events: " + error.message);
          throw error;
        }
      }

      // Initialize form elements and event listeners
      function initializeFormElements() {
        // Initialize select2
        $(".select").select2({
          minimumResultsForSearch: -1,
          width: "100%",
        });

        // Initialize datetimepicker
        $(".datetimepicker").datetimepicker({
          format: "DD-MM-YYYY",
          icons: {
            up: "fas fa-angle-up",
            down: "fas fa-angle-down",
            next: "fas fa-angle-right",
            previous: "fas fa-angle-left",
          },
        });

        // Event change handler to auto-fill the end date
        document
          .getElementById("eventSelect")
          .addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const eventEndDate = selectedOption.dataset.eventEndDate || "";

            if (eventEndDate) {
              // Format the date if needed
              $("#eventEndDate").val(moment(eventEndDate).format("DD-MM-YYYY"));
            } else {
              $("#eventEndDate").val("");
            }
          });

        // Add event listeners for buttons
        document
          .getElementById("fetchProductsBtn")
          .addEventListener("click", fetchEventProducts);
        document
          .getElementById("submitReturnBtn")
          .addEventListener("click", submitReturn);
      }

      // Function to fetch event products
      async function fetchEventProducts() {
        try {
          const eventSelect = document.getElementById("eventSelect");
          const selectedOption = eventSelect.options[eventSelect.selectedIndex];

          if (eventSelect.selectedIndex === 0) {
            showError("Please select an event");
            return;
          }

          const eventId = selectedOption.dataset.eventId;
          const eventName = selectedOption.value;

          // Create a query to get products for this event
          let productsQuery;

          // First try to query by event ID
          if (eventId) {
            productsQuery = query(
              collection(db, "eventProducts"),
              where("eventId", "==", eventId)
            );
          } else {
            // Fallback to query by event name
            productsQuery = query(
              collection(db, "eventProducts"),
              where("eventName", "==", eventName)
            );
          }

          const productsSnapshot = await getDocs(productsQuery);

          if (productsSnapshot.empty) {
            showInfo("No products found for this event");
            clearProductTable();
            updateTotals();
            return;
          }

          // Clear existing product rows
          const tableBody = document.getElementById("productTableBody");
          tableBody.innerHTML = "";

          // Add product rows
          productsSnapshot.forEach((doc) => {
            const productData = doc.data();
            addProductRow(productData, doc.id);
          });

          // Update totals
          updateTotals();

          showSuccess(
            `Loaded ${productsSnapshot.size} products for event: ${eventName}`
          );
        } catch (error) {
          console.error("Error fetching event products:", error);
          showError("Failed to fetch products: " + error.message);
        }
      }

      // Function to add a product row to the table
      function addProductRow(productData, docId) {
        const tableBody = document.getElementById("productTableBody");
        const row = document.createElement("tr");
        row.dataset.productId = docId;

        const allocatedQty = productData.allocatedQty || 0;

        row.innerHTML = `
    <td class="productimgname">
      <a class="product-img">
        <img src="${
          productData.image || "assets/img/product/product7.jpg"
        }" alt="product" />
      </a>
      <a href="javascript:void(0);">${
        productData.productName || "Unknown Product"
      }</a>
    </td>
    <td>${productData.productId || docId}</td>
    <td>${allocatedQty}</td>
    <td>
      <input type="number" class="form-control returned-qty" value="${allocatedQty}" 
            min="0" max="${allocatedQty}" />
    </td>
    <td>
      <input type="number" class="form-control damaged-qty" value="0" 
            min="0" max="${allocatedQty}" />
    </td>
    <td>
      <select class="select verification-status">
        <option value="">Select Status</option>
        <option value="Verified">Verified</option>
        <option value="Pending" selected>Pending</option>
        <option value="Missing">Missing</option>
      </select>
    </td>
    <td>
      <input type="text" class="form-control product-notes" placeholder="Add notes" />
    </td>
    <td>
      <a class="delete-set" onclick="removeProductRow(this)"><img src="assets/img/icons/delete.svg" alt="svg" /></a>
    </td>
  `;

        tableBody.appendChild(row);

        // Initialize select2 for the new row
        $(row).find(".select").select2({
          minimumResultsForSearch: -1,
          width: "100%",
        });

        // Add event listeners for quantity changes
        const returnedQtyInput = row.querySelector(".returned-qty");
        const damagedQtyInput = row.querySelector(".damaged-qty");

        returnedQtyInput.addEventListener("change", () => {
          validateQuantities(row);
          updateTotals();
        });

        damagedQtyInput.addEventListener("change", () => {
          validateQuantities(row);
          updateTotals();
        });

        // Add listener for status changes
        $(row).find(".verification-status").on("change", updateTotals);
      }

      // Function to validate quantities
      function validateQuantities(row) {
        const allocatedQty = parseInt(
          row.querySelector("td:nth-child(3)").textContent
        );
        const returnedQtyInput = row.querySelector(".returned-qty");
        const damagedQtyInput = row.querySelector(".damaged-qty");

        let returnedQty = parseInt(returnedQtyInput.value) || 0;
        let damagedQty = parseInt(damagedQtyInput.value) || 0;

        // Ensure returned + damaged doesn't exceed allocated
        if (returnedQty + damagedQty > allocatedQty) {
          // If damaged is causing the excess, adjust damaged
          if (returnedQty <= allocatedQty) {
            damagedQty = allocatedQty - returnedQty;
            damagedQtyInput.value = damagedQty;
          } else {
            // Otherwise adjust returned
            returnedQty = allocatedQty;
            returnedQtyInput.value = returnedQty;
            damagedQty = 0;
            damagedQtyInput.value = damagedQty;
          }

          showWarning(
            "Total of returned and damaged quantities cannot exceed allocated quantity"
          );
        }
      }

      // Function to clear the product table
      function clearProductTable() {
        document.getElementById("productTableBody").innerHTML = "";
      }

      // Function to update totals
      function updateTotals() {
        const rows = document.querySelectorAll("#productTableBody tr");
        let totalAllocated = 0;
        let totalReturned = 0;
        let totalDamaged = 0;
        let allVerified = true;

        rows.forEach((row) => {
          const allocatedQty =
            parseInt(row.querySelector("td:nth-child(3)").textContent) || 0;
          const returnedQty =
            parseInt(row.querySelector(".returned-qty").value) || 0;
          const damagedQty =
            parseInt(row.querySelector(".damaged-qty").value) || 0;
          const status = $(row).find(".verification-status").val();

          totalAllocated += allocatedQty;
          totalReturned += returnedQty;
          totalDamaged += damagedQty;

          // Check if all products are verified
          if (status !== "Verified") {
            allVerified = false;
          }
        });

        // Update the summary display
        document.getElementById("totalAllocated").textContent = totalAllocated;
        document.getElementById("totalReturned").textContent = totalReturned;
        document.getElementById("totalDamaged").textContent = totalDamaged;

        // Update overall status
        const overallStatusElement = document.getElementById("overallStatus");
        if (rows.length === 0) {
          overallStatusElement.textContent = "Pending";
        } else if (allVerified) {
          overallStatusElement.textContent = "Verified";
          overallStatusElement.style.color = "#28a745";
        } else {
          overallStatusElement.textContent = "Pending";
          overallStatusElement.style.color = "#ffc107";
        }
      }

      // Function to remove a product row
      window.removeProductRow = function (element) {
        const row = element.closest("tr");

        // Confirm deletion
        Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, delete it!",
        }).then((result) => {
          if (result.isConfirmed) {
            row.remove();
            updateTotals();
            Swal.fire(
              "Deleted!",
              "The product has been removed from the return list.",
              "success"
            );
          }
        });
      };

      // Function to submit the return
      async function submitReturn() {
        try {
          const eventSelect = document.getElementById("eventSelect");
          const selectedOption = eventSelect.options[eventSelect.selectedIndex];

          if (eventSelect.selectedIndex === 0) {
            showError("Please select an event");
            return;
          }

          const eventId = selectedOption.dataset.eventId;
          const eventName = selectedOption.text;
          const eventEndDate = document.getElementById("eventEndDate").value;
          const referenceNumber =
            document.getElementById("referenceNumber").value;
          const returnNotes = document.getElementById("returnNotes").value;

          // Get all product rows
          const rows = document.querySelectorAll("#productTableBody tr");

          if (rows.length === 0) {
            showError("No products to return");
            return;
          }

          // Build products data
          const products = [];

          rows.forEach((row) => {
            const productId = row.dataset.productId;
            const productName = row.querySelector(
              ".productimgname a:last-child"
            ).textContent;
            const allocatedQty =
              parseInt(row.querySelector("td:nth-child(3)").textContent) || 0;
            const returnedQty =
              parseInt(row.querySelector(".returned-qty").value) || 0;
            const damagedQty =
              parseInt(row.querySelector(".damaged-qty").value) || 0;
            const status = $(row).find(".verification-status").val();
            const notes = row.querySelector(".product-notes").value;

            products.push({
              productId,
              productName,
              allocatedQty,
              returnedQty,
              damagedQty,
              verificationStatus: status,
              notes,
            });
          });

          // Create return document
          const returnData = {
            eventId,
            eventName,
            eventEndDate,
            referenceNumber,
            returnNotes,
            products,
            totalAllocated: parseInt(
              document.getElementById("totalAllocated").textContent
            ),
            totalReturned: parseInt(
              document.getElementById("totalReturned").textContent
            ),
            totalDamaged: parseInt(
              document.getElementById("totalDamaged").textContent
            ),
            overallStatus: document.getElementById("overallStatus").textContent,
            createdAt: serverTimestamp(),
            createdBy: auth.currentUser ? auth.currentUser.uid : "unknown",
          };

          // Save to Firebase
          const docRef = await addDoc(
            collection(db, "eventReturns"),
            returnData
          );

          showSuccess("Return successfully submitted with ID: " + docRef.id);

          // Ask if they want to go to the return list
          Swal.fire({
            title: "Success!",
            text: "Return successfully recorded. Would you like to view all returns?",
            icon: "success",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, view returns",
            cancelButtonText: "No, stay here",
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = "salesreturnlist.html";
            }
          });
        } catch (error) {
          console.error("Error submitting return:", error);
          showError("Failed to submit return: " + error.message);
        }
      }

      // Helper functions for notifications
      function showSuccess(message) {
        Swal.fire({
          position: "top-end",
          icon: "success",
          title: message,
          showConfirmButton: false,
          timer: 2000,
        });
      }

      function showError(message) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: message,
        });
      }

      function showWarning(message) {
        Swal.fire({
          icon: "warning",
          title: "Warning",
          text: message,
        });
      }

      function showInfo(message) {
        Swal.fire({
          icon: "info",
          title: "Information",
          text: message,
        });
      }
    </script>

    <script src="assets/js/script.js"></script>
  </body>
</html>
